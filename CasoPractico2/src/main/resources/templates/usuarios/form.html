<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/base}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title th:text="${titulo} + ' - Plataforma Académica'">Formulario Usuario</title>
</head>
<body>
    <div layout:fragment="content">
        <!-- Header del formulario -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="h4 fw-bold mb-1">
                    <i th:class="${titulo == 'Nuevo Usuario'} ? 'bi bi-person-plus text-primary' : 'bi bi-pencil-square text-warning'"></i>
                    <span th:text="${titulo}" class="ms-2"></span>
                </h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a th:href="@{/home}">Inicio</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/admin/usuarios}">Usuarios</a></li>
                        <li class="breadcrumb-item active" th:text="${titulo}"></li>
                    </ol>
                </nav>
            </div>
            <div>
                <a th:href="@{/admin/usuarios}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>
                    Volver a la lista
                </a>
            </div>
        </div>

        <!-- Mensajes de éxito/error -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span th:text="${mensaje}">Operación exitosa</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span th:text="${mensaje}">Error en la operación</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Formulario principal -->
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-card-checklist me-2"></i>
                            Información del Usuario
                        </h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/admin/usuarios/guardar}" th:object="${usuario}" method="post" id="usuarioForm">
                            <input type="hidden" th:field="*{id}">
                            
                            <div class="row">
                                <!-- Nombre -->
                                <div class="col-md-6 mb-3">
                                    <label for="nombre" class="form-label fw-semibold">
                                        <i class="bi bi-person me-1"></i>
                                        Nombre <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="nombre" 
                                           th:field="*{nombre}"
                                           required
                                           placeholder="Ingrese el nombre">
                                    <div class="invalid-feedback">
                                        El nombre es requerido
                                    </div>
                                </div>
                                
                                <!-- Apellido -->
                                <div class="col-md-6 mb-3">
                                    <label for="apellido" class="form-label fw-semibold">
                                        <i class="bi bi-person-badge me-1"></i>
                                        Apellido <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="apellido" 
                                           th:field="*{apellido}"
                                           required
                                           placeholder="Ingrese el apellido">
                                    <div class="invalid-feedback">
                                        El apellido es requerido
                                    </div>
                                </div>
                                
                                <!-- Email -->
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label fw-semibold">
                                        <i class="bi bi-envelope me-1"></i>
                                        Email <span class="text-danger">*</span>
                                    </label>
                                    <input type="email" 
                                           class="form-control" 
                                           id="email" 
                                           th:field="*{email}"
                                           required
                                           placeholder="usuario@ejemplo.com"
                                           th:attr="data-original=${usuario.email}">
                                    <div class="form-text">
                                        Este email se usará para iniciar sesión
                                    </div>
                                    <div class="invalid-feedback">
                                        Ingrese un email válido
                                    </div>
                                </div>
                                
                                <!-- Contraseña (solo para nuevo usuario) -->
                                <div class="col-md-6 mb-3" th:if="${usuario.id == null or usuario.id == 0}">
                                    <label for="password" class="form-label fw-semibold">
                                        <i class="bi bi-key me-1"></i>
                                        Contraseña <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="password" 
                                               class="form-control" 
                                               id="password" 
                                               th:field="*{password}"
                                               required
                                               placeholder="Ingrese la contraseña"
                                               th:attr="minlength=5">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('password')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Mínimo 5 caracteres. Por defecto: <code>12345</code>
                                    </div>
                                    <div class="invalid-feedback">
                                        La contraseña es requerida (mínimo 5 caracteres)
                                    </div>
                                </div>
                                
                                <!-- Contraseña (para editar) -->
                                <div class="col-md-6 mb-3" th:unless="${usuario.id == null or usuario.id == 0}">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-key me-1"></i>
                                        Contraseña
                                    </label>
                                    <div class="input-group">
                                        <input type="password" 
                                               class="form-control" 
                                               id="passwordEdit" 
                                               th:field="*{password}"
                                               placeholder="Dejar vacío para mantener la actual"
                                               th:attr="minlength=5">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('passwordEdit')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Dejar vacío para mantener la contraseña actual
                                    </div>
                                </div>
                                
                                <!-- Rol -->
                                <div class="col-md-6 mb-3">
                                    <label for="rol" class="form-label fw-semibold">
                                        <i class="bi bi-shield-check me-1"></i>
                                        Rol <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" 
                                            id="rol" 
                                            th:field="*{rol.id}"
                                            required>
                                        <option value="">Seleccione un rol...</option>
                                        <option th:each="rol : ${roles}" 
                                                th:value="${rol.id}" 
                                                th:text="${rol.nombre}"
                                                th:selected="${usuario.rol != null and usuario.rol.id == rol.id}">
                                        </option>
                                    </select>
                                    <div class="form-text">
                                        Define los permisos del usuario en el sistema
                                    </div>
                                    <div class="invalid-feedback">
                                        Seleccione un rol
                                    </div>
                                </div>
                                
                                <!-- Estado -->
                                <div class="col-md-6 mb-4">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-toggle-on me-1"></i>
                                        Estado
                                    </label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="activo"
                                               th:checked="${usuario.activo}"
                                               th:field="*{activo}">
                                        <label class="form-check-label" for="activo">
                                            Usuario Activo
                                        </label>
                                    </div>
                                    <div class="form-text">
                                        Desactive para suspender el acceso del usuario
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Botones del formulario -->
                            <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                                <div>
                                    <button type="reset" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-clockwise me-1"></i>
                                        Limpiar
                                    </button>
                                </div>
                                <div>
                                    <a th:href="@{/admin/usuarios}" class="btn btn-outline-danger me-2">
                                        <i class="bi bi-x-circle me-1"></i>
                                        Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-1"></i>
                                        <span th:text="${usuario.id == null or usuario.id == 0} ? 'Crear Usuario' : 'Actualizar Usuario'"></span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Panel lateral -->
            <div class="col-lg-4">
                <!-- Información de Ayuda -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Información Importante
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                <small>Todos los campos marcados con <span class="text-danger">*</span> son obligatorios</small>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                <small>El email debe ser único para cada usuario</small>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                <small>La contraseña por defecto es <code>12345</code></small>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                <small>El rol determina los permisos del usuario</small>
                            </li>
                            <li>
                                <i class="bi bi-check-circle text-success me-2"></i>
                                <small>Un usuario inactivo no podrá iniciar sesión</small>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- Descripción de Roles -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-warning text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-shield me-2"></i>
                            Descripción de Roles
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <span class="badge bg-danger mb-1 d-block">ADMIN</span>
                            <small class="text-muted">Acceso completo al sistema. Puede gestionar usuarios, roles y configuraciones.</small>
                        </div>
                        <div class="mb-3">
                            <span class="badge bg-warning mb-1 d-block">PROFESOR</span>
                            <small class="text-muted">Acceso a reportes y consultas. Puede ver información de estudiantes.</small>
                        </div>
                        <div>
                            <span class="badge bg-info mb-1 d-block">ESTUDIANTE</span>
                            <small class="text-muted">Acceso limitado. Solo puede ver y editar su propio perfil.</small>
                        </div>
                    </div>
                </div>
                
                <!-- Acciones Rápidas (solo para edición) -->
                <div th:if="${usuario.id != null and usuario.id > 0}" class="card shadow-sm border-0 mt-4">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">
                            <i class="bi bi-lightning me-2"></i>
                            Acciones Rápidas
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="button" 
                                    class="btn btn-outline-warning btn-sm"
                                    onclick="resetPassword(${usuario.id})">
                                <i class="bi bi-key me-1"></i>
                                Resetear Contraseña
                            </button>
                            <button type="button" 
                                    class="btn btn-outline-danger btn-sm"
                                    th:if="${usuario.rol.nombre != 'ADMIN'}"
                                    onclick="confirmarEliminar(${usuario.id}, '${usuario.nombre}')">
                                <i class="bi bi-trash me-1"></i>
                                Eliminar Usuario
                            </button>
                            <button type="button" 
                                    class="btn btn-outline-secondary btn-sm"
                                    th:classappend="${usuario.activo} ? 'btn-outline-danger' : 'btn-outline-success'"
                                    onclick="toggleActivo(${usuario.id}, ${usuario.activo})">
                                <i th:class="${usuario.activo} ? 'bi bi-person-x' : 'bi bi-person-check'"></i>
                                <span th:text="${usuario.activo} ? 'Desactivar Usuario' : 'Activar Usuario'"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div layout:fragment="scripts">
        <script>
            // Mostrar/ocultar contraseña
            function togglePassword(inputId) {
                const input = document.getElementById(inputId);
                const button = input.nextElementSibling;
                const icon = button.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                }
            }
            
            // Validación del formulario
            document.getElementById('usuarioForm').addEventListener('submit', function(e) {
                let valid = true;
                
                // Validar campos requeridos
                const requiredFields = this.querySelectorAll('[required]');
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        field.classList.add('is-invalid');
                        valid = false;
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });
                
                // Validar email único (simulación)
                const emailField = document.getElementById('email');
                const originalEmail = emailField.getAttribute('data-original');
                if (emailField.value && emailField.value !== originalEmail) {
                    // Aquí podrías hacer una llamada AJAX para verificar si el email ya existe
                    console.log('Verificando disponibilidad de email:', emailField.value);
                }
                
                if (!valid) {
                    e.preventDefault();
                    showToast('Por favor, complete todos los campos requeridos', 'error');
                }
            });
            
            // Resetear contraseña
            function resetPassword(usuarioId) {
                if (confirm('¿Resetear contraseña a "12345"? Esto enviará un correo al usuario.')) {
                    window.location.href = `/admin/usuarios/reset-password/${usuarioId}`;
                }
            }
            
            // Confirmar eliminación
            function confirmarEliminar(usuarioId, nombre) {
                if (confirm(`¿Está seguro de eliminar al usuario "${nombre}"? Esta acción no se puede deshacer.`)) {
                    window.location.href = `/admin/usuarios/eliminar/${usuarioId}`;
                }
            }
            
            // Activar/desactivar usuario
            function toggleActivo(usuarioId, estaActivo) {
                const accion = estaActivo ? 'desactivar' : 'activar';
                if (confirm(`¿${accion.charAt(0).toUpperCase() + accion.slice(1)} este usuario?`)) {
                    window.location.href = `/admin/usuarios/toggle-activo/${usuarioId}`;
                }
            }
            
            // Función para mostrar notificaciones
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast align-items-center text-white bg-${type} border-0`;
                toast.setAttribute('role', 'alert');
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;
                
                const container = document.getElementById('toast-container') || createToastContainer();
                container.appendChild(toast);
                
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
                
                toast.addEventListener('hidden.bs.toast', () => toast.remove());
            }
            
            function createToastContainer() {
                const container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'position-fixed bottom-0 end-0 p-3';
                container.style.zIndex = '1055';
                document.body.appendChild(container);
                return container;
            }
            
            // Auto-ocultar alertas
            setTimeout(() => {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(alert => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
            
            // Cargar información del usuario si está editando
            document.addEventListener('DOMContentLoaded', function() {
                const usuarioId = document.querySelector('input[name="id"]')?.value;
                if (usuarioId && usuarioId > 0) {
                    console.log('Editando usuario ID:', usuarioId);
                    // Aquí podrías cargar información adicional con AJAX
                }
            });
        </script>
        
        <style>
            /* Estilos específicos para el formulario */
            .form-control:focus, .form-select:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
            }
            
            .form-check-input:checked {
                background-color: #667eea;
                border-color: #667eea;
            }
            
            .card {
                transition: transform 0.2s ease;
            }
            
            .card:hover {
                transform: translateY(-2px);
            }
            
            .breadcrumb {
                background: transparent;
                padding-left: 0;
            }
            
            .breadcrumb-item a {
                text-decoration: none;
                color: #667eea;
            }
            
            .breadcrumb-item.active {
                color: #6c757d;
            }
            
            /* Estilos para los badges de roles */
            .badge.bg-danger, .badge.bg-warning, .badge.bg-info {
                font-size: 0.75rem;
                padding: 0.25em 0.6em;
                border-radius: 10px;
            }
        </style>
    </div>
</body>
</html>